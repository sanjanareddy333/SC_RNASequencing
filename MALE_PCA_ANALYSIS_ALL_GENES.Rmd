---
title: "MALE_PCA_ANALYSIS_ALL_GENES"
output: html_document
date: "2026-01-09"
---
```{r setup, include=FALSE}
############################################################
## MALE ONLY: QC + CELL-LEVEL UMAP + SLICE PCA
## NO GENE EXCLUSION - ALL GENES INCLUDED
############################################################

suppressPackageStartupMessages({
  library(Seurat)
  library(dplyr)
  library(ggplot2)
  library(Matrix)
  library(plotly)
  library(htmlwidgets)
  library(pheatmap)
  library(ggrepel)
})

############################################################
## 0. PATHS (EDIT IF NEEDED)
############################################################

root_dir <- "/Users/preddy/Desktop/Lab_Streeter_new/NEW_PCA_ANALYSIS/MALE_PCA_WITH_ALL_GENES_RESULTS"

male_its2_path <- "/Users/preddy/Desktop/Lab_Streeter_new/Male/ITS2.csv"

male_paths <- list(
  CONTROL = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/Control_filtered_feature_bc_matrix.h5",
  REVERSA = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/Reversa_filtered_feature_bc_matrix.h5",
  REVREV  = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/Reversed_Reversa_filtered_feature_bc_matrix.h5",
  RRAC226 = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/RR_AC226_filtered_feature_bc_matrix.h5"
)

## Folder structure
dir_map <- list(
  QC = file.path(root_dir, "QC"),
  Cell_Level = file.path(root_dir, "Cell_Level"),
  UMAP = file.path(root_dir, "UMAP"),
  SliceMapping = file.path(root_dir, "SliceMapping"),
  Slice_PCA = file.path(root_dir, "Slice_PCA"),
  Loadings = file.path(root_dir, "Loadings"),
  Heatmaps_GenesExpressed = file.path(root_dir, "Heatmaps_GenesExpressed"),
  PCA_Heatmaps = file.path(root_dir, "PCA_Heatmaps")
)

invisible(lapply(dir_map, dir.create, showWarnings = FALSE, recursive = TRUE))
for (pc in c("PC1","PC2","PC3")) dir.create(file.path(dir_map$PCA_Heatmaps, pc), showWarnings = FALSE)

cat("Saving results to:\n", root_dir, "\n\n")
```
```{r helper_functions, include=FALSE}
############################################################
## 1. HELPER FUNCTIONS
############################################################

save_plot <- function(p, filename, width = 7, height = 6, dpi = 300, subdir = NULL) {
  out_path <- if (is.null(subdir)) file.path(root_dir, filename) else file.path(subdir, filename)
  ggsave(filename = out_path, plot = p, width = width, height = height, dpi = dpi)
  invisible(out_path)
}

clean_barcode <- function(bc) {
  bc <- sub("^.*_", "", bc)
  bc <- sub("-\\d+$", "", bc)
  bc
}

clean_slice_id <- function(x) {
  x <- trimws(x)
  x <- sub("\\s+ITS$", "", x)
  x
}

compute_genes_expressed <- function(seu) {
  counts_mat <- GetAssayData(seu, assay = "RNA", slot = "counts")
  seu$genes_expressed <- Matrix::colSums(counts_mat > 0)
  seu
}

make_pseudobulk_by_slice <- function(seu, genes = NULL) {
  slices <- unique(seu$slice_id)
  slices <- slices[!is.na(slices)]
  if (length(slices) < 2) stop("Need >=2 slices for slice-level PCA.")

  if (is.null(genes)) {
    genes <- rownames(seu)
  }
  
  expr <- GetAssayData(seu, assay = "RNA", slot = "data")[genes, , drop = FALSE]
  expr <- as.matrix(expr)

  pseudobulk <- matrix(0, nrow = length(genes), ncol = length(slices))
  rownames(pseudobulk) <- genes
  colnames(pseudobulk) <- slices

  slice_counts <- data.frame(slice_id = slices, n_cells = NA_integer_)

  for (i in seq_along(slices)) {
    sl <- slices[i]
    idx <- which(seu$slice_id == sl)
    slice_counts$n_cells[i] <- length(idx)
    if (length(idx) > 0) pseudobulk[, i] <- rowMeans(expr[, idx, drop = FALSE])
  }

  list(pseudobulk = pseudobulk, slice_counts = slice_counts)
}

run_slice_pca <- function(pseudobulk) {
  pca <- prcomp(t(pseudobulk), center = TRUE, scale. = FALSE)
  var <- (pca$sdev^2 / sum(pca$sdev^2)) * 100
  list(pca = pca, var = var)
}

get_pc_genes <- function(pca_obj, pc = "PC1", n = 30) {
  v <- pca_obj$rotation[, pc]
  top_pos <- names(sort(v, decreasing = TRUE))[1:n]
  top_neg <- names(sort(v, decreasing = FALSE))[1:n]
  unique(c(top_pos, top_neg))
}

make_z_mat <- function(pseudobulk, genes, slice_order_vec) {
  genes <- genes[genes %in% rownames(pseudobulk)]
  slice_order_vec <- slice_order_vec[slice_order_vec %in% colnames(pseudobulk)]
  mat <- pseudobulk[genes, slice_order_vec, drop = FALSE]
  mat <- t(scale(t(mat)))
  mat[is.na(mat)] <- 0
  mat
}

save_pc_loadings <- function(pca_obj, out_csv, top_n = 30) {
  loadings <- pca_obj$rotation
  get_tbl <- function(pc_name) {
    pos <- sort(loadings[, pc_name], decreasing = TRUE)[1:top_n]
    neg <- sort(loadings[, pc_name], decreasing = FALSE)[1:top_n]
    rbind(
      data.frame(PC = pc_name, direction = "positive", gene = names(pos), loading = as.numeric(pos)),
      data.frame(PC = pc_name, direction = "negative", gene = names(neg), loading = as.numeric(neg))
    )
  }
  tbl <- rbind(get_tbl("PC1"), get_tbl("PC2"), get_tbl("PC3"))
  write.csv(tbl, out_csv, row.names = FALSE)
  tbl
}

plot_genes_expressed_heatmap_static_and_interactive <- function(seu, out_png, out_html) {
  meta_df <- seu[[]] %>%
    mutate(barcode = rownames(.)) %>%
    filter(!is.na(slice_id)) %>%
    select(barcode, slice_id, genes_expressed)

  if (nrow(meta_df) == 0) stop("No rows for heatmap; slice_id missing.")

  slice_order <- meta_df %>%
    count(slice_id, name = "n_spots") %>%
    arrange(desc(n_spots)) %>%
    pull(slice_id)

  meta_df$slice_id <- factor(meta_df$slice_id, levels = slice_order)

  meta_df <- meta_df %>%
    group_by(slice_id) %>%
    arrange(genes_expressed) %>%
    mutate(spot_index = row_number()) %>%
    ungroup()

  p <- ggplot(
    meta_df,
    aes(
      x = spot_index,
      y = factor(slice_id, levels = rev(slice_order)),
      fill = genes_expressed,
      text = paste0(
        "Slice: ", slice_id,
        "<br>Barcode: ", barcode,
        "<br>Genes expressed: ", genes_expressed
      )
    )
  ) +
    geom_tile(height = 0.85, color = "white", linewidth = 0.15) +
    scale_fill_gradientn(
      colours = c("#7f0000", "#d7301f", "#fc8d59", "#fee08b", "#ffffbf"),
      name = "genes_expressed"
    ) +
    labs(
      title = "Genes expressed per spot (All slices combined)",
      x = "Spots (within slice)",
      y = "Slice ID"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      panel.grid.major.y = element_line(color = "grey70", linewidth = 0.3),
      panel.grid.major.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank()
    )

  ggsave(out_png, p, width = 12, height = 7, dpi = 300)

  p_int <- ggplotly(p, tooltip = "text")
  saveWidget(p_int, file = out_html, selfcontained = TRUE)

  invisible(p_int)
}
```
```{r load_data, include=FALSE}
############################################################
## 3. LOAD DATA + MERGE
############################################################

cat("Loading MALE...\n")

male_objs <- lapply(names(male_paths), function(nm) {
  x <- Read10X_h5(male_paths[[nm]])
  obj <- CreateSeuratObject(x, project = nm)

  obj$sample <- nm
  obj$sex <- "Male"

  obj$barcode_clean <- clean_barcode(colnames(obj))
  obj$barcode_id <- paste(obj$sex, obj$sample, obj$barcode_clean, sep = "_")

  stopifnot(!any(duplicated(obj$barcode_id)))
  obj
})

male <- merge(
  male_objs[[1]],
  y = male_objs[-1],
  add.cell.ids = names(male_paths),
  project = "Male"
)

## Seurat v5 layer join
male[["RNA"]] <- JoinLayers(male[["RNA"]])

## Write MALE metadata CSV
male_meta_df <- male[[]] %>%
  mutate(cell_barcode = rownames(.)) %>%
  select(cell_barcode, everything())

male_csv <- file.path(root_dir, "Male_Metadata_all_genes.csv")
write.csv(male_meta_df, male_csv, row.names = FALSE)

cat("Male metadata saved at:\n", male_csv, "\n")

# Check samples
table(male$sample)

# Check metadata columns
colnames(male@meta.data)
```
```{r qc_metrics, include=FALSE}
############################################################
## 4. QC METRICS + PLOTS
############################################################

cat("Computing QC metrics...\n")
male[["percent.mt"]] <- PercentageFeatureSet(male, pattern = "^mt-")
if (all(male$percent.mt == 0)) {
  male[["percent.mt"]] <- PercentageFeatureSet(male, pattern = "^MT-")
}

male <- compute_genes_expressed(male)

## Violin plots by sample
p_violin_sample <- VlnPlot(
  male,
  features = c("nFeature_RNA", "nCount_RNA", "percent.mt"),
  group.by = "sample",
  pt.size = 0.1,
  ncol = 3
)

save_plot(p_violin_sample, "QC_Violin_BySample.png", 12, 5, subdir = dir_map$QC)
cat("✓ Saved: QC_Violin_BySample.png\n")
```
```{r normalize_variable_features, include=FALSE}
############################################################
## 5. NORMALIZE + FIND VARIABLE FEATURES
############################################################

cat("Normalizing and finding variable features...\n")
male <- NormalizeData(male)
male <- FindVariableFeatures(male, nfeatures = 2000)

## Plot variable features
top10 <- head(VariableFeatures(male), 10)
p_var <- VariableFeaturePlot(male)
p_var <- LabelPoints(plot = p_var, points = top10, repel = TRUE)
p_var <- p_var + 
  labs(
    title = "Highly Variable Genes (All Genes Included)",
    subtitle = paste0("n = ", length(VariableFeatures(male)), " genes")
  )

save_plot(p_var, "VariableFeatures.png", 8, 6, subdir = dir_map$QC)
cat("✓ Saved: VariableFeatures.png\n")
p_var
```
```{r cell_level_pca_umap, include=FALSE}
############################################################
## 6. CELL-LEVEL PCA + ELBOW + UMAP
############################################################

cat("Scaling data and running cell-level PCA...\n")
male <- ScaleData(male)
male <- RunPCA(male, npcs = 30)

p_elbow <- ElbowPlot(male, ndims = 30) +
  labs(title = "Elbow Plot (Cell-level PCA)")

save_plot(p_elbow, "ElbowPlot_CellLevel.png", 7, 5, subdir = dir_map$Cell_Level)
cat("✓ Saved: ElbowPlot_CellLevel.png\n")
p_elbow

cat("Running UMAP...\n")
male <- RunUMAP(male, dims = 1:20)

## UMAP colored by sample
sample_colors <- c(
  CONTROL  = "#1f77b4",  # blue
  REVERSA  = "#2ca02c",  # green
  REVREV   = "#d62728",  # red
  RRAC226  = "#ff7f0e"   # orange
)

p_umap_sample <- DimPlot(
  male,
  group.by = "sample"
) +
  scale_color_manual(values = sample_colors) +
  theme_minimal(base_size = 14) +
  labs(
    title = "UMAP by Sample (Male)",
    color = "Sample"
  )
save_plot(p_umap_sample, "UMAP_BySample.png", 9, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_BySample.png\n")

p_umap_sample
```
```{r feature_plots, include=FALSE}
############################################################
## 7. FEATURE PLOTS (GENES EXPRESSED, MT%, nFeature)
############################################################

p_genes <- FeaturePlot(male, features = "genes_expressed", reduction = "umap") +
  theme_minimal(base_size = 14) +
  labs(title = "Genes expressed per spot (UMAP)")

save_plot(p_genes, "UMAP_GenesExpressed.png", 7, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_GenesExpressed.png\n")
p_genes

p_mt <- FeaturePlot(male, features = "percent.mt", reduction = "umap") +
  theme_minimal(base_size = 14) +
  labs(title = "percent.mt (UMAP)")

save_plot(p_mt, "UMAP_percentMT.png", 7, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_percentMT.png\n")
p_mt

p_nFeature <- FeaturePlot(male, features = "nFeature_RNA", reduction = "umap") +
  theme_minimal(base_size = 14) +
  labs(title = "nFeature_RNA (UMAP)")

save_plot(p_nFeature, "UMAP_nFeatureRNA.png", 7, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_nFeatureRNA.png\n")
p_nFeature
```
```{r its2_mapping, include=FALSE}
############################################################
## 8. ITS2 MAPPING + SLICE COUNTS
############################################################

cat("Loading Male ITS2 mapping...\n")

male_its <- read.csv(male_its2_path, stringsAsFactors = FALSE)
male_its$slice_id <- clean_slice_id(male_its$ITS2)

male_slice_treatment <- data.frame(
  slice_id = c(
    "314A ITS", "321A", "321B",
    "45-3A", "45-4A", "45-4B", "54-3B",
    "49-1A", "49-1B",
    "45-1A", "45-1B", "45-1C", "45-1D", "45-2A", "45-2B", "45-2C"
  ),
  sample_label = c(
    rep("CONTROL", 3),
    rep("REVERSA", 4),
    rep("REVREV", 2),
    rep("RRAC226", 7)
  ),
  stringsAsFactors = FALSE
)

male_slice_treatment$slice_id_clean <- clean_slice_id(male_slice_treatment$slice_id)

male_its$sample_label <- male_slice_treatment$sample_label[
  match(male_its$slice_id, male_slice_treatment$slice_id_clean)
]

male_its <- male_its %>% filter(!is.na(sample_label))

male_its$barcode_clean <- clean_barcode(male_its$Barcode)

male_its$barcode_id <- paste(
  "Male",
  male_its$sample_label,
  male_its$barcode_clean,
  sep = "_"
)

write.csv(
  male_its,
  file.path(dir_map$SliceMapping, "Male_ITS2_with_barcode_id.csv"),
  row.names = FALSE
)

# Build slice → treatment mapping for PCA
male_slice_treatment$slice_id <- clean_slice_id(male_slice_treatment$slice_id)

slice_treatment <- male_slice_treatment %>%
  rename(treatment = sample_label) %>%
  distinct(slice_id, treatment)

# Attach slice_id to Seurat
male$slice_id <- male_its$slice_id[
  match(male$barcode_id, male_its$barcode_id)
]

# Save seurat metadata with slice_id
meta <- male@meta.data
write.csv(
  meta,
  file.path(dir_map$SliceMapping, "male_metadata_with_slice_id.csv"),
  row.names = TRUE
)

# Slice barcode counts
slice_barcode_counts <- meta %>%
  filter(!is.na(slice_id)) %>%
  count(slice_id, name = "n_barcodes") %>%
  arrange(desc(n_barcodes))

write.csv(
  slice_barcode_counts,
  file.path(dir_map$SliceMapping, "Slice_Barcode_Counts.csv"),
  row.names = FALSE
)

cat("Slice barcode counts:\n")
print(slice_barcode_counts)
```
```{r slice_pca, include=FALSE}
############################################################
## 9. SLICE-LEVEL PSEUDOBULK + PCA
############################################################

cat("\nCreating pseudobulk profiles and running slice-level PCA...\n")

## Use variable features for PCA
var_genes <- VariableFeatures(male)
pb <- make_pseudobulk_by_slice(male, genes = var_genes)
pseudobulk <- pb$pseudobulk

cat("Pseudobulk matrix dimensions:", nrow(pseudobulk), "genes x", ncol(pseudobulk), "slices\n")

pca_out <- run_slice_pca(pseudobulk)
pca_result <- pca_out$pca
pca_var <- pca_out$var

cat("PC variance explained:\n")
print(head(pca_var, 10))

pca_df <- data.frame(
  slice_id = rownames(pca_result$x),
  PC1 = pca_result$x[, 1],
  PC2 = pca_result$x[, 2],
  PC3 = pca_result$x[, 3],
  stringsAsFactors = FALSE
)

pca_df <- left_join(pca_df, slice_treatment, by = "slice_id")

write.csv(pca_df, file.path(dir_map$Slice_PCA, "SlicePCA_Coordinates_PC1_PC2_PC3.csv"), row.names = FALSE)
```
```{r slice_pca_plots, include=FALSE}
############################################################
## 10. SLICE PCA PLOTS (PC1 vs PC2, PC2 vs PC3)
############################################################

treat_colors <- c(
  CONTROL  = "#1f77b4",  # blue
  REVERSA  = "#2ca02c",  # green
  REVREV   = "#d62728",  # red
  RRAC226  = "#ff7f0e"   # orange
)

p_pc1_pc2 <- ggplot(
  pca_df,
  aes(PC1, PC2, color = treatment, group = treatment)
) +
  geom_point(size = 3, alpha = 0.9) +
  geom_text_repel(
    aes(label = slice_id),
    size = 4,
    color = "black"
  ) +
  stat_ellipse(
    type = "t",
    level = 0.95,
    linewidth = 0.8
  ) +
  theme_minimal(base_size = 16) +
  labs(
    title = "Slice-level PCA (Male Only)",
    x = paste0("PC1 (", round(pca_var[1], 1), "%)"),
    y = paste0("PC2 (", round(pca_var[2], 1), "%)")
  ) +
  scale_color_manual(values = treat_colors, name = "Treatment Group")

save_plot(p_pc1_pc2, "SlicePCA_PC1_vs_PC2_ByTreatment.png", 8, 6, subdir = dir_map$Slice_PCA)
cat("✓ Saved: SlicePCA_PC1_vs_PC2_ByTreatment.png\n")
p_pc1_pc2

p_pc2_pc3 <- ggplot(pca_df, aes(PC2, PC3, color = treatment, label = slice_id, group = treatment)) +
  geom_point(size = 3, alpha = 0.9) +
  geom_text_repel(
    aes(label = slice_id),
    size = 4,
    color = "black",
    segment.color = "grey50",
    segment.size = 0.4,
    box.padding = 0.4,
    point.padding = 0.3,
    max.overlaps = Inf
  ) +
  stat_ellipse(
    type = "t",
    level = 0.95,
    linewidth = 0.8
  ) +
  theme_minimal(base_size = 16) +
  labs(
    title = "Slice-level PCA (Male Only)",
    subtitle = paste0("PC2 vs PC3, n = ", nrow(pca_df), " slices"),
    x = paste0("PC2 (", round(pca_var[2], 1), "%)"),
    y = paste0("PC3 (", round(pca_var[3], 1), "%)")
  ) +
  scale_color_manual(values = treat_colors, name = "Treatment Group")

save_plot(p_pc2_pc3, "SlicePCA_PC2_vs_PC3_ByTreatment.png", 8, 6, subdir = dir_map$Slice_PCA)
cat("✓ Saved: SlicePCA_PC2_vs_PC3_ByTreatment.png\n")
p_pc2_pc3
```
```{r pc_loadings, include=FALSE}
############################################################
## 11. LOADINGS CSV (PC1 PC2 PC3)
############################################################

cat("Saving PC loadings...\n")
loadings_tbl <- save_pc_loadings(
  pca_result,
  out_csv = file.path(dir_map$Loadings, "Top_PC_Loadings_PC1_PC2_PC3.csv"),
  top_n = 30
)

cat("\nTop 5 positive and negative genes for each PC:\n")
for (pc in c("PC1", "PC2", "PC3")) {
  cat("\n", pc, ":\n", sep = "")
  print(loadings_tbl %>% filter(PC == pc) %>% head(5))
}
```
```{r genes_expressed_heatmaps, include=FALSE}
############################################################
## 12. GENES EXPRESSED HEATMAPS (STATIC + INTERACTIVE)
############################################################

cat("\nGenerating genes_expressed heatmaps...\n")
plot_genes_expressed_heatmap_static_and_interactive(
  male,
  out_png  = file.path(dir_map$Heatmaps_GenesExpressed, "Heatmap_GenesExpressed_AllSlices_Static.png"),
  out_html = file.path(dir_map$Heatmaps_GenesExpressed, "Heatmap_GenesExpressed_AllSlices_Interactive.html")
)
cat("✓ Saved: Heatmap_GenesExpressed heatmaps\n")
```
```{r pc_gene_heatmaps, include=FALSE}
############################################################
## 13. PC GENE HEATMAPS (DEFAULT / BY TREATMENT / BY LIKENESS)
############################################################

cat("\nGenerating PC gene heatmaps...\n")

annotation_col <- data.frame(treatment = pca_df$treatment)
rownames(annotation_col) <- pca_df$slice_id

ann_colors <- list(treatment = treat_colors)

## Slice order by treatment
slice_order_treatment <- pca_df %>%
  filter(!is.na(treatment)) %>%
  arrange(
    factor(treatment, levels = c("CONTROL", "REVERSA", "REVREV", "RRAC226")), 
    PC1
  ) %>%
  pull(slice_id)

for (pc in c("PC1","PC2","PC3")) {

  cat("  Processing", pc, "heatmaps...\n")
  
  genes <- get_pc_genes(pca_result, pc = pc, n = 30)

  ## 1) DEFAULT (cluster both rows and columns)
  mat_default <- make_z_mat(pseudobulk, genes, colnames(pseudobulk))
  pheatmap(
    mat_default,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    annotation_col = annotation_col[colnames(mat_default), , drop = FALSE],
    annotation_colors = ann_colors,
    color = colorRampPalette(c("#2166ac", "white", "#b2182b"))(100),
    main = paste(pc, "top loading genes (Default clustering)"),
    filename = file.path(dir_map$PCA_Heatmaps, pc, paste0("Heatmap_", pc, "_Default.png")),
    width = 9, height = 10
  )

  ## 2) BY TREATMENT (no column clustering)
  mat_treat <- make_z_mat(pseudobulk, genes, slice_order_treatment)
  pheatmap(
    mat_treat,
    cluster_rows = TRUE,
    cluster_cols = FALSE,
    annotation_col = annotation_col[colnames(mat_treat), , drop = FALSE],
    annotation_colors = ann_colors,
    color = colorRampPalette(c("#2166ac", "white", "#b2182b"))(100),
    main = paste(pc, "top loading genes (Ordered by Treatment)"),
    filename = file.path(dir_map$PCA_Heatmaps, pc, paste0("Heatmap_", pc, "_ByTreatment.png")),
    width = 9, height = 10
  )

  ## 3) BY LIKENESS (PC score order)
  slice_order_likeness <- pca_df %>% arrange(.data[[pc]]) %>% pull(slice_id)
  slice_order_likeness <- slice_order_likeness[slice_order_likeness %in% colnames(pseudobulk)]

  mat_like <- make_z_mat(pseudobulk, genes, slice_order_likeness)
  pheatmap(
    mat_like,
    cluster_rows = TRUE,
    cluster_cols = FALSE,
    annotation_col = annotation_col[colnames(mat_like), , drop = FALSE],
    annotation_colors = ann_colors,
    color = colorRampPalette(c("#2166ac", "white", "#b2182b"))(100),
    main = paste(pc, "top loading genes (Ordered by PC score)"),
    filename = file.path(dir_map$PCA_Heatmaps, pc, paste0("Heatmap_", pc, "_ByLikeness.png")),
    width = 9, height = 10
  )
}

cat("✓ Saved: All PC heatmaps\n")
```
```{r save_final, include=FALSE}
############################################################
## 14. SAVE FINAL SEURAT OBJECT
############################################################

cat("\nSaving final Seurat object...\n")
saveRDS(male, file = file.path(root_dir, "Male_Seurat_all_genes.rds"))
cat("✓ Saved: Male_Seurat_all_genes.rds\n")

############################################################
## 15. SESSION INFO (FOR REPRODUCIBILITY)
############################################################

cat("\n==============================================\n")
cat("SESSION INFO\n")
cat("==============================================\n")
sessionInfo()

cat("\n✅ ANALYSIS COMPLETE!\n")
cat("All outputs saved to:", root_dir, "\n")
cat("==============================================\n")
```