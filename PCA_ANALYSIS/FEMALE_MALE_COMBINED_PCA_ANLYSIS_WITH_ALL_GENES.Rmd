-
title: "Male_Female_Combined_PCA_Analysis"
output: html_document
date: "2026-01-09"
---

```{r setup, include=FALSE}
############################################################
## COMBINED MALE + FEMALE: QC + CELL-LEVEL UMAP + SLICE PCA
## NO GENE EXCLUSION - ALL GENES INCLUDED
############################################################

suppressPackageStartupMessages({
  library(Seurat)
  library(dplyr)
  library(ggplot2)
  library(Matrix)
  library(plotly)
  library(htmlwidgets)
  library(pheatmap)
})

############################################################
## 0. PATHS (EDIT IF NEEDED)
############################################################

root_dir <- "/Users/preddy/Desktop/Lab_Streeter_new/FEMALE_MALE_COMBINED_PCA_RESULTS"

male_its2_path   <- "/Users/preddy/Desktop/Lab_Streeter_new/Male/ITS2.csv"
female_its2_path <- "/Users/preddy/Desktop/Lab_Streeter_new/Female/ITS2.csv"

female_paths <- list(
  WT1 = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Female_DataSet/data/WT_Control1_filtered_feature_bc_matrix.h5",
  WT2 = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Female_DataSet/data/WT_Control2_filtered_feature_bc_matrix.h5",
  TG1 = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Female_DataSet/data/Treatment_Group1_filtered_feature_bc_matrix.h5",
  TG2 = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Female_DataSet/data/Treatment_Group2_filtered_feature_bc_matrix.h5"
)

male_paths <- list(
  CONTROL = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/Control_filtered_feature_bc_matrix.h5",
  REVERSA = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/Reversa_filtered_feature_bc_matrix.h5",
  REVREV  = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/Reversed_Reversa_filtered_feature_bc_matrix.h5",
  RRAC226 = "/Users/preddy/Desktop/Lab_Streeter/Sanjana/Male_DataSet/data/RR_AC226_filtered_feature_bc_matrix.h5"
)

## Folder structure
dir_map <- list(
  QC = file.path(root_dir, "QC"),
  Cell_Level = file.path(root_dir, "Cell_Level"),
  UMAP = file.path(root_dir, "UMAP"),
  SliceMapping = file.path(root_dir, "SliceMapping"),
  Slice_PCA = file.path(root_dir, "Slice_PCA"),
  Loadings = file.path(root_dir, "Loadings"),
  Heatmaps_GenesExpressed = file.path(root_dir, "Heatmaps_GenesExpressed"),
  PCA_Heatmaps = file.path(root_dir, "PCA_Heatmaps")
)

invisible(lapply(dir_map, dir.create, showWarnings = FALSE, recursive = TRUE))
for (pc in c("PC1","PC2","PC3")) dir.create(file.path(dir_map$PCA_Heatmaps, pc), showWarnings = FALSE)

cat("Saving results to:\n", root_dir, "\n\n")
```
```{r setup, include=FALSE}
############################################################
## 1. HELPER FUNCTIONS
############################################################

save_plot <- function(p, filename, width = 7, height = 6, dpi = 300, subdir = NULL) {
  out_path <- if (is.null(subdir)) file.path(root_dir, filename) else file.path(subdir, filename)
  ggsave(filename = out_path, plot = p, width = width, height = height, dpi = dpi)
  invisible(out_path)
}

clean_barcode <- function(bc) {
  bc <- sub("^.*_", "", bc)
  bc <- sub("-\\d+$", "", bc)
  bc
}



compute_genes_expressed <- function(seu) {
  counts_mat <- GetAssayData(seu, assay = "RNA", slot = "counts")
  seu$genes_expressed <- Matrix::colSums(counts_mat > 0)
  seu
}

make_pseudobulk_by_slice <- function(seu, genes = NULL) {
  slices <- unique(seu$slice_id)
  slices <- slices[!is.na(slices)]
  if (length(slices) < 2) stop("Need >=2 slices for slice-level PCA.")

  if (is.null(genes)) {
    genes <- rownames(seu)
  }
  
  expr <- GetAssayData(seu, assay = "RNA", slot = "data")[genes, , drop = FALSE]
  expr <- as.matrix(expr)

  pseudobulk <- matrix(0, nrow = length(genes), ncol = length(slices))
  rownames(pseudobulk) <- genes
  colnames(pseudobulk) <- slices

  slice_counts <- data.frame(slice_id = slices, n_cells = NA_integer_)

  for (i in seq_along(slices)) {
    sl <- slices[i]
    idx <- which(seu$slice_id == sl)
    slice_counts$n_cells[i] <- length(idx)
    if (length(idx) > 0) pseudobulk[, i] <- rowMeans(expr[, idx, drop = FALSE])
  }

  list(pseudobulk = pseudobulk, slice_counts = slice_counts)
}

run_slice_pca <- function(pseudobulk) {
  pca <- prcomp(t(pseudobulk), center = TRUE, scale. = FALSE)
  var <- (pca$sdev^2 / sum(pca$sdev^2)) * 100
  list(pca = pca, var = var)
}

get_pc_genes <- function(pca_obj, pc = "PC1", n = 30) {
  v <- pca_obj$rotation[, pc]
  top_pos <- names(sort(v, decreasing = TRUE))[1:n]
  top_neg <- names(sort(v, decreasing = FALSE))[1:n]
  unique(c(top_pos, top_neg))
}

make_z_mat <- function(pseudobulk, genes, slice_order_vec) {
  genes <- genes[genes %in% rownames(pseudobulk)]
  slice_order_vec <- slice_order_vec[slice_order_vec %in% colnames(pseudobulk)]
  mat <- pseudobulk[genes, slice_order_vec, drop = FALSE]
  mat <- t(scale(t(mat)))
  mat[is.na(mat)] <- 0
  mat
}

save_pc_loadings <- function(pca_obj, out_csv, top_n = 30) {
  loadings <- pca_obj$rotation
  get_tbl <- function(pc_name) {
    pos <- sort(loadings[, pc_name], decreasing = TRUE)[1:top_n]
    neg <- sort(loadings[, pc_name], decreasing = FALSE)[1:top_n]
    rbind(
      data.frame(PC = pc_name, direction = "positive", gene = names(pos), loading = as.numeric(pos)),
      data.frame(PC = pc_name, direction = "negative", gene = names(neg), loading = as.numeric(neg))
    )
  }
  tbl <- rbind(get_tbl("PC1"), get_tbl("PC2"), get_tbl("PC3"))
  write.csv(tbl, out_csv, row.names = FALSE)
  tbl
}

plot_genes_expressed_heatmap_static_and_interactive <- function(seu, out_png, out_html) {
  meta_df <- seu[[]] %>%
    mutate(barcode = rownames(.)) %>%
    filter(!is.na(slice_id)) %>%
    select(barcode, slice_id, genes_expressed)

  if (nrow(meta_df) == 0) stop("No rows for heatmap; slice_id missing.")

  slice_order <- meta_df %>%
    count(slice_id, name = "n_spots") %>%
    arrange(desc(n_spots)) %>%
    pull(slice_id)

  meta_df$slice_id <- factor(meta_df$slice_id, levels = slice_order)

  meta_df <- meta_df %>%
    group_by(slice_id) %>%
    arrange(genes_expressed) %>%
    mutate(spot_index = row_number()) %>%
    ungroup()

  p <- ggplot(
    meta_df,
    aes(
      x = spot_index,
      y = factor(slice_id, levels = rev(slice_order)),
      fill = genes_expressed,
      text = paste0(
        "Slice: ", slice_id,
        "<br>Barcode: ", barcode,
        "<br>Genes expressed: ", genes_expressed
      )
    )
  ) +
    geom_tile(height = 0.85, color = "white", linewidth = 0.15) +
    scale_fill_gradientn(
      colours = c("#7f0000", "#d7301f", "#fc8d59", "#fee08b", "#ffffbf"),
      name = "genes_expressed"
    ) +
    labs(
      title = "Genes expressed per spot (All slices combined)",
      x = "Spots (within slice)",
      y = "Slice ID"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      panel.grid.major.y = element_line(color = "grey70", linewidth = 0.3),
      panel.grid.major.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank()
    )

  ggsave(out_png, p, width = 12, height = 7, dpi = 300)

  p_int <- ggplotly(p, tooltip = "text")
  saveWidget(p_int, file = out_html, selfcontained = TRUE)

  invisible(p_int)
}
```

```{r setup, include=FALSE}
############################################################
## 3. LOAD DATA + MERGE
############################################################

cat("Loading FEMALE...\n")

female_objs <- lapply(names(female_paths), function(nm) {
  x <- Read10X_h5(female_paths[[nm]])
  obj <- CreateSeuratObject(x, project = nm)

  obj$sample <- nm
  obj$sex <- "Female"

  obj$barcode_clean <- clean_barcode(colnames(obj))
  obj$barcode_id <- paste(obj$sex, obj$sample, obj$barcode_clean, sep = "_")

  stopifnot(!any(duplicated(obj$barcode_id)))
  obj
})

female <- merge(
  female_objs[[1]],
  y = female_objs[-1],
  add.cell.ids = names(female_paths),
  project = "Female"
)

## Write FEMALE metadata CSV
female_meta_df <- female[[]] %>%
  mutate(cell_barcode = rownames(.)) %>%
  select(cell_barcode, everything())

female_csv <- file.path(root_dir, "Female_seurat_metadata_with_barcode_id.csv")
write.csv(female_meta_df, female_csv, row.names = FALSE)

cat("Female metadata saved at:\n", female_csv, "\n")

cat("Loading MALE...\n")

male_objs <- lapply(names(male_paths), function(nm) {
  x <- Read10X_h5(male_paths[[nm]])
  obj <- CreateSeuratObject(x, project = nm)

  obj$sample <- nm
  obj$sex <- "Male"

  obj$barcode_clean <- clean_barcode(colnames(obj))
  obj$barcode_id <- paste(obj$sex, obj$sample, obj$barcode_clean, sep = "_")

  stopifnot(!any(duplicated(obj$barcode_id)))
  obj
})

male <- merge(
  male_objs[[1]],
  y = male_objs[-1],
  add.cell.ids = names(male_paths),
  project = "Male"
)

## Write MALE metadata CSV
male_meta_df <- male[[]] %>%
  mutate(cell_barcode = rownames(.)) %>%
  select(cell_barcode, everything())

male_csv <- file.path(root_dir, "Male_seurat_metadata_with_barcode_id.csv")
write.csv(male_meta_df, male_csv, row.names = FALSE)

cat("Male metadata saved at:\n", male_csv, "\n")

cat("Merging FEMALE + MALE...\n")

seurat_all <- merge(
  x = female,
  y = male,
  add.cell.ids = c("Female", "Male"),
  project = "Combined"
)

## Seurat v5 layer join
seurat_all[["RNA"]] <- JoinLayers(seurat_all[["RNA"]])


## Write COMBINED metadata CSV
combined_meta_df <- seurat_all[[]] %>%
  mutate(cell_barcode = rownames(.)) %>%
  select(cell_barcode, everything())

combined_csv <- file.path(root_dir, "Combined_seurat_metadata_with_barcode_id.csv")
write.csv(combined_meta_df, combined_csv, row.names = FALSE)

cat("Combined metadata saved at:\n", combined_csv, "\n")


# Check samples
table(seurat_all$sample)

# Check metadata columns
colnames(seurat_all@meta.data)
```

```{rsetup }
############################################################
## 4. QC METRICS + PLOTS
#Quality control metrics were computed for the combined Seurat object, including the number of detected genes (nFeature_RNA), total UMI counts (nCount_RNA), mitochondrial gene percentage (percent.mt), and the number of genes expressed per cell. Violin plots were generated to compare these QC metrics across samples and between sexes, enabling assessment of data quality and identification of potential batch or sex-specific technical biases prior to downstream analysis.
############################################################

cat("Computing QC metrics...\n")
seurat_all[["percent.mt"]] <- PercentageFeatureSet(seurat_all, pattern = "^mt-")
if (all(seurat_all$percent.mt == 0)) {
  seurat_all[["percent.mt"]] <- PercentageFeatureSet(seurat_all, pattern = "^MT-")
}

seurat_all <- compute_genes_expressed(seurat_all)

## Violin plots by sample
p_violin_sample <- VlnPlot(
  seurat_all,
  features = c("nFeature_RNA", "nCount_RNA", "percent.mt"),
  group.by = "sample",
  pt.size = 0.1,
  ncol = 3
)

save_plot(p_violin_sample, "QC_Violin_BySample.png", 12, 5, subdir = dir_map$QC)
cat("✓ Saved: QC_Violin_BySample.png\n")

## Violin plots by sex
p_violin_sex <- VlnPlot(
  seurat_all,
  features = c("nFeature_RNA", "nCount_RNA", "percent.mt"),
  group.by = "sex",
  pt.size = 0.1,
  ncol = 3
)

save_plot(p_violin_sex, "QC_Violin_BySex.png", 12, 5, subdir = dir_map$QC)
cat("✓ Saved: QC_Violin_BySex.png\n")
```

```{r setup, include=FALSE}
############################################################
## 5. NORMALIZE + FIND VARIABLE FEATURES
############################################################

cat("Normalizing and finding variable features...\n")
seurat_all <- NormalizeData(seurat_all)
seurat_all <- FindVariableFeatures(seurat_all, nfeatures = 2000)

## Plot variable features
top10 <- head(VariableFeatures(seurat_all), 10)
p_var <- VariableFeaturePlot(seurat_all)
p_var <- LabelPoints(plot = p_var, points = top10, repel = TRUE)
p_var <- p_var + 
  labs(
    title = "Highly Variable Genes (All Genes Included)",
    subtitle = paste0("n = ", length(VariableFeatures(seurat_all)), " genes")
  )

save_plot(p_var, "VariableFeatures.png", 8, 6, subdir = dir_map$QC)
cat("✓ Saved: VariableFeatures.png\n")
p_var
```
```{r setup, include=FALSE}

############################################################
## 6. CELL-LEVEL PCA + ELBOW + UMAP
############################################################

cat("Scaling data and running cell-level PCA...\n")
seurat_all <- ScaleData(seurat_all)
seurat_all <- RunPCA(seurat_all, npcs = 30)

p_elbow <- ElbowPlot(seurat_all, ndims = 30) +
  labs(title = "Elbow Plot (Cell-level PCA)")

save_plot(p_elbow, "ElbowPlot_CellLevel.png", 7, 5, subdir = dir_map$Cell_Level)
cat("✓ Saved: ElbowPlot_CellLevel.png\n")
p_elbow

cat("Running UMAP...\n")
seurat_all <- RunUMAP(seurat_all, dims = 1:20)

## UMAP colored by sample

sample_colors <- c(
  WT1      = "#d73027",  # red
  WT2      = "#f46d43",  # lighter red
  CONTROL  = "#a50026",  # dark red (male control)

  TG1      = "#1a9850",  # green
  REVERSA  = "#66bd63",  # black

  TG2      = "#000000",  # light green
  RRAC226  ="#969696",  # yellow/orange
  
  REVREV   =  "#0000FF"  # grey (related to black)

)

p_umap_sample <- DimPlot(
  seurat_all,
  group.by = "sample"
) +
  scale_color_manual(values = sample_colors) +
  theme_minimal(base_size = 14) +
  labs(
    title = "UMAP by Sample",
    color = "Sample"
  )
save_plot(p_umap_sample, "UMAP_BySample.png", 9, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_BySample.png\n")

p_umap_sample

## UMAP colored by sex
p_umap_sex <- DimPlot(seurat_all, group.by = "sex") +
  theme_minimal(base_size = 14) +
  labs(title = "UMAP by Sex")

save_plot(p_umap_sex, "UMAP_BySex.png", 9, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_BySex.png\n")

p_umap_sex

```


```{r setup, include=FALSE}
############################################################
## 7. FEATURE PLOTS (GENES EXPRESSED, MT%, nFeature)
############################################################

p_genes <- FeaturePlot(seurat_all, features = "genes_expressed", reduction = "umap") +
  theme_minimal(base_size = 14) +
  labs(title = "Genes expressed per spot (UMAP)")

save_plot(p_genes, "UMAP_GenesExpressed.png", 7, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_GenesExpressed.png\n")
p_genes

p_mt <- FeaturePlot(seurat_all, features = "percent.mt", reduction = "umap") +
  theme_minimal(base_size = 14) +
  labs(title = "percent.mt (UMAP)")

save_plot(p_mt, "UMAP_percentMT.png", 7, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_percentMT.png\n")
p_mt

p_nFeature <- FeaturePlot(seurat_all, features = "nFeature_RNA", reduction = "umap") +
  theme_minimal(base_size = 14) +
  labs(title = "nFeature_RNA (UMAP)")

save_plot(p_nFeature, "UMAP_nFeatureRNA.png", 7, 6, subdir = dir_map$UMAP)
cat("✓ Saved: UMAP_nFeatureRNA.png\n")
p_nFeature
```

```{r setup, include=FALSE}
############################################################
## 8. ITS2 MAPPING (MALE + FEMALE) + SLICE COUNTS
############################################################

female_barcodes_df <- data.frame(
  barcode_raw   = colnames(female),
  barcode_clean = clean_barcode(colnames(female)),
  sex           = "Female",
  stringsAsFactors = FALSE
)

write.csv(
  female_barcodes_df,
  "Female_Barcodes.csv",
  row.names = FALSE
)


female_barcodes_df <- data.frame(
  barcode_raw   = colnames(female),
  barcode_clean = clean_barcode(colnames(female)),
  sex           = "Female",
  stringsAsFactors = FALSE
)

write.csv(
  female_barcodes_df,
  "Female_Barcodes.csv",
  row.names = FALSE
)


female_its <- read.csv(female_its2_path, stringsAsFactors = FALSE)

female_its$slice_id <- clean_slice_id(female_its$ITS2)

female_slice_treatment <- data.frame(
  slice_id = c(
    "315A", "315B",
    "312A", "317", "312B",
    "44-3A", "44-3B", "42A", "42B",
    "46-2A", "46-2B", "44-2"
  ),
  sample_label = c(
    rep("WT1", 2),
    rep("WT2", 3),
    rep("TG1", 4),
    rep("TG2", 3)
  ),
  stringsAsFactors = FALSE
)

female_slice_treatment$slice_id_clean <- clean_slice_id(female_slice_treatment$slice_id)

female_its$sample_label <- female_slice_treatment$sample_label[
  match(female_its$slice_id, female_slice_treatment$slice_id_clean)
]

# Drop unmapped
female_its <- female_its %>% filter(!is.na(sample_label))

female_its <- read.csv(female_its2_path, stringsAsFactors = FALSE)

female_its$slice_id <- clean_slice_id(female_its$ITS2)

female_slice_treatment <- data.frame(
  slice_id = c(
    "315A", "315B","312A", 
    "317", "312B",
    "44-3A", "44-3B", "42A", "42B",
    "46-2A", "46-2B", "44-2"
  ),
  sample_label = c(
    rep("WT1", 3),
    rep("WT2", 2),
    rep("TG1", 4),
    rep("TG2", 3)
  ),
  stringsAsFactors = FALSE
)

female_slice_treatment$slice_id_clean <- clean_slice_id(female_slice_treatment$slice_id)

female_its$sample_label <- female_slice_treatment$sample_label[
  match(female_its$slice_id, female_slice_treatment$slice_id_clean)
]

# Drop unmapped
female_its <- female_its %>% filter(!is.na(sample_label))

female_its$barcode_clean <- clean_barcode(female_its$Barcode)

female_its$barcode_id <- paste(
  "Female",
  female_its$sample_label,
  female_its$barcode_clean,
  sep = "_"
)

write.csv(
  female_its,
  "Female_ITS2_with_barcode_id.csv",
  row.names = FALSE
)


cat("Loading MALE...\n")

male_objs <- lapply(names(male_paths), function(nm) {
  mat <- Read10X_h5(male_paths[[nm]])
  obj <- CreateSeuratObject(mat, project = nm)
  obj$sex <- "Male"
  obj$sample <- nm
  obj
})

male <- merge(
  male_objs[[1]],
  y = male_objs[-1],
  add.cell.ids = names(male_paths),
  project = "Male"
)


male_barcodes_df <- data.frame(
  barcode_raw   = colnames(male),
  barcode_clean = clean_barcode(colnames(male)),
  sex           = "Male",
  stringsAsFactors = FALSE
)

write.csv(
  male_barcodes_df,
  "Male_Barcodes.csv",
  row.names = FALSE
)

male_its <- read.csv(male_its2_path, stringsAsFactors = FALSE)

male_its$slice_id <- clean_slice_id(male_its$ITS2)

male_slice_treatment <- data.frame(
  slice_id = c(
    "314A ITS", "321A", "321B",
    "45-3A", "45-4A","45-4B","54-3B",
    "49-1A", "49-1B",
    "45-1A", "45-1B", "45-1C", "45-1D", "45-2A", "45-2B","45-2C"
  ),
  sample_label = c(
    rep("CONTROL", 3),
    rep("REVERSA", 4),
    rep("REVREV", 2),
    rep("RRAC226", 7)
  ),
  stringsAsFactors = FALSE
)

male_slice_treatment$slice_id_clean <- clean_slice_id(male_slice_treatment$slice_id)

male_its$sample_label <- male_slice_treatment$sample_label[
  match(male_its$slice_id, male_slice_treatment$slice_id_clean)
]

male_its <- male_its %>% filter(!is.na(sample_label))

male_its$barcode_clean <- clean_barcode(male_its$Barcode)

male_its$barcode_id <- paste(
  "Male",
  male_its$sample_label,
  male_its$barcode_clean,
  sep = "_"
)

write.csv(
  male_its,
  "Male_ITS2_with_barcode_id.csv",
  row.names = FALSE
)

its_all <- bind_rows(male_its, female_its)

write.csv(
  its_all,
  "ITS2_Combined_with_barcode_id.csv",
  row.names = FALSE
)

seurat_all$barcode_clean <- clean_barcode(colnames(seurat_all))

seurat_all$barcode_id <- paste(
  seurat_all$sex,
  seurat_all$sample,
  seurat_all$barcode_clean,
  sep = "_"
)

seurat_all$slice_id <- its_all$ITS2[
  match(seurat_all$barcode_id, its_all$barcode_id)
]

write.csv(
  seurat_all@meta.data,
  "seurat_all_metadata_with_slice_id.csv"
)

unique_rows_with_slice <- unique(
  meta[!is.na(meta$slice_id), ]
)

nrow(unique_rows_with_slice)
unique_rows_with_slice
```

```{r setup, include=FALSE}

############################################################
## 9. SLICE-LEVEL PSEUDOBULK + PCA
############################################################

cat("\nCreating pseudobulk profiles and running slice-level PCA...\n")

## Use variable features for PCA
var_genes <- VariableFeatures(seurat_all)
pb <- make_pseudobulk_by_slice(seurat_all, genes = var_genes)
pseudobulk <- pb$pseudobulk

cat("Pseudobulk matrix dimensions:", nrow(pseudobulk), "genes x", ncol(pseudobulk), "slices\n")

pca_out <- run_slice_pca(pseudobulk)
pca_result <- pca_out$pca
pca_var <- pca_out$var

cat("PC variance explained:\n")
print(head(pca_var, 10))

pca_df <- data.frame(
  slice_id = rownames(pca_result$x),
  PC1 = pca_result$x[, 1],
  PC2 = pca_result$x[, 2],
  PC3 = pca_result$x[, 3],
  stringsAsFactors = FALSE
)

pca_df <- left_join(pca_df, slice_treatment, by = "slice_id")

write.csv(pca_df, file.path(dir_map$Slice_PCA, "SlicePCA_Coordinates_PC1_PC2_PC3.csv"), row.names = FALSE)

############################################################
## 10. SLICE PCA PLOTS (PC1 vs PC2, PC2 vs PC3)
############################################################

treat_colors <- c(
  WT = "#2E86AB",
  Reversa = "#A23B72",
  RevReversa = "#6A4C93",
  RRAC226 = "#F18F01"
)

p_pc1_pc2 <- ggplot(pca_df, aes(PC1, PC2, color = treatment,label = slice_id,group = treatment)) +
  geom_point(size = 3, alpha = 0.9) +
geom_text_repel(
  aes(label = slice_id),
  size = 4,
  color = "black",
  segment.color = "grey50",
  segment.size = 0.4,
  box.padding = 0.4,
  point.padding = 0.3,
  max.overlaps = Inf
) +
  stat_ellipse(
    type = "t",
    level = 0.95,
    linewidth = 0.8
  ) +  theme_minimal(base_size = 16) +
  labs(
    title = "Slice-level PCA (Combined Male + Female)",
    subtitle = paste0("PC1 vs PC2, n = ", nrow(pca_df), " slices"),
    x = paste0("PC1 (", round(pca_var[1], 1), "%)"),
    y = paste0("PC2 (", round(pca_var[2], 1), "%)")
  ) +
  scale_color_manual(values = treat_colors, name = "Treatment Group")

save_plot(p_pc1_pc2, "SlicePCA_PC1_vs_PC2_ByTreatment.png", 8, 6, subdir = dir_map$Slice_PCA)
cat("✓ Saved: SlicePCA_PC1_vs_PC2_ByTreatment.png\n")

p_pc2_pc3 <- ggplot(pca_df, aes(PC2, PC3, color = treatment,   label = slice_id ,group = treatment)) +
  geom_point(size = 3, alpha = 0.9) +
 geom_text_repel(
  aes(label = slice_id),
  size = 4,
  color = "black",
  segment.color = "grey50",
  segment.size = 0.4,
  box.padding = 0.4,
  point.padding = 0.3,
  max.overlaps = Inf
) +
  stat_ellipse(
    type = "t",
    level = 0.95,
    linewidth = 0.8
  ) +
  theme_minimal(base_size = 16) +
  labs(
    title = "Slice-level PCA (Combined Male + Female)",
    subtitle = paste0("PC2 vs PC3, n = ", nrow(pca_df), " slices"),
    x = paste0("PC2 (", round(pca_var[2], 1), "%)"),
    y = paste0("PC3 (", round(pca_var[3], 1), "%)")
  ) +
  scale_color_manual(values = treat_colors, name = "Treatment Group")

save_plot(p_pc2_pc3, "SlicePCA_PC2_vs_PC3_ByTreatment.png", 8, 6, subdir = dir_map$Slice_PCA)
cat("✓ Saved: SlicePCA_PC2_vs_PC3_ByTreatment.png\n")

############################################################
## 11. LOADINGS CSV (PC1 PC2 PC3)
############################################################

cat("Saving PC loadings...\n")
loadings_tbl <- save_pc_loadings(
  pca_result,
  out_csv = file.path(dir_map$Loadings, "Top_PC_Loadings_PC1_PC2_PC3.csv"),
  top_n = 30
)

cat("\nTop 5 positive and negative genes for each PC:\n")
for (pc in c("PC1", "PC2", "PC3")) {
  cat("\n", pc, ":\n", sep = "")
  print(loadings_tbl %>% filter(PC == pc) %>% head(5))
}

############################################################
## 12. GENES EXPRESSED HEATMAPS (STATIC + INTERACTIVE)
############################################################

cat("\nGenerating genes_expressed heatmaps...\n")
plot_genes_expressed_heatmap_static_and_interactive(
  seurat_all,
  out_png  = file.path(dir_map$Heatmaps_GenesExpressed, "Heatmap_GenesExpressed_AllSlices_Static.png"),
  out_html = file.path(dir_map$Heatmaps_GenesExpressed, "Heatmap_GenesExpressed_AllSlices_Interactive.html")
)
cat("✓ Saved: Heatmap_GenesExpressed heatmaps\n")

############################################################
## 13. PC GENE HEATMAPS (DEFAULT / BY TREATMENT / BY LIKENESS)
############################################################

cat("\nGenerating PC gene heatmaps...\n")

annotation_col <- data.frame(treatment = pca_df$treatment)
rownames(annotation_col) <- pca_df$slice_id

ann_colors <- list(treatment = treat_colors)

## Slice order by treatment
slice_order_treatment <- pca_df %>%
  filter(!is.na(treatment)) %>%
  arrange(factor(treatment, levels = c("WT","Reversa","RevReversa","RRAC226")), PC1) %>%
  pull(slice_id)

for (pc in c("PC1","PC2","PC3")) {

  cat("  Processing", pc, "heatmaps...\n")
  
  genes <- get_pc_genes(pca_result, pc = pc, n = 30)

  ## 1) DEFAULT (cluster both rows and columns)
  mat_default <- make_z_mat(pseudobulk, genes, colnames(pseudobulk))
  pheatmap(
    mat_default,
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    annotation_col = annotation_col[colnames(mat_default), , drop = FALSE],
    annotation_colors = ann_colors,
    color = colorRampPalette(c("#2166ac", "white", "#b2182b"))(100),
    main = paste(pc, "top loading genes (Default clustering)"),
    filename = file.path(dir_map$PCA_Heatmaps, pc, paste0("Heatmap_", pc, "_Default.png")),
    width = 9, height = 10
  )

  ## 2) BY TREATMENT (no column clustering)
  mat_treat <- make_z_mat(pseudobulk, genes, slice_order_treatment)
  pheatmap(
    mat_treat,
    cluster_rows = TRUE,
    cluster_cols = FALSE,
    annotation_col = annotation_col[colnames(mat_treat), , drop = FALSE],
    annotation_colors = ann_colors,
    color = colorRampPalette(c("#2166ac", "white", "#b2182b"))(100),
    main = paste(pc, "top loading genes (Ordered by Treatment)"),
    filename = file.path(dir_map$PCA_Heatmaps, pc, paste0("Heatmap_", pc, "_ByTreatment.png")),
    width = 9, height = 10
  )

  ## 3) BY LIKENESS (PC score order)
  slice_order_likeness <- pca_df %>% arrange(.data[[pc]]) %>% pull(slice_id)
  slice_order_likeness <- slice_order_likeness[slice_order_likeness %in% colnames(pseudobulk)]

  mat_like <- make_z_mat(pseudobulk, genes, slice_order_likeness)
  pheatmap(
    mat_like,
    cluster_rows = TRUE,
    cluster_cols = FALSE,
    annotation_col = annotation_col[colnames(mat_like), , drop = FALSE],
    annotation_colors = ann_colors,
    color = colorRampPalette(c("#2166ac", "white", "#b2182b"))(100),
    main = paste(pc, "top loading genes (Ordered by PC score)"),
    filename = file.path(dir_map$PCA_Heatmaps, pc, paste0("Heatmap_", pc, "_ByLikeness.png")),
    width = 9, height = 10
  )
}

############################################################
## 14. SAVE FINAL SEURAT OBJECT
############################################################

cat("\nSaving final Seurat object...\n")
saveRDS(seurat_all, file = file.path(root_dir, "Combined_Male_Female_Seurat.rds"))
cat("✓ Saved: Combined_Male_Female_Seurat.rds\n")

############################################################
## 15. SESSION INFO (FOR REPRODUCIBILITY)
############################################################

cat("\n==============================================\n")
cat("SESSION INFO\n")
cat("==============================================\n")
sessionInfo()

cat("\n✅ ANALYSIS COMPLETE!\n")
cat("All outputs saved to:", root_dir, "\n")
cat("==============================================\n")
```
```

---

## **Key Changes:**

### **1. Genes Removed IMMEDIATELY After Loading** ⭐⭐⭐
```r
## Section 4: PHYSICALLY REMOVE GENES FROM DATA
seurat_all <- subset(seurat_all, features = genes_to_keep)
```

This uses `subset()` to **physically remove** unwanted genes from all assay slots (counts, data, scale.data).

### **2. Simplified Workflow**
- No more `get_pca_genes_excluding()` function (not needed!)
- No more `VariableFeatures()` reassignment
- Just one "VariableFeatures" plot (after filtering)
- Cleaner, more straightforward code

### **3. What This Fixes:**
- ✅ **Heatmaps** will NOT show cardiac/RBC genes
- ✅ **Variable features** detection won't even consider excluded genes
- ✅ **All downstream analyses** (PCA, UMAP, clustering) use only clean genes
- ✅ **Loadings** will only contain valve-relevant genes
- ✅ **Consistent** filtering across ALL analyses

### **4. Console Output Now Shows:**
